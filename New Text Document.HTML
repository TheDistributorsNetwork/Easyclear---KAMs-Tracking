# Courtesy Call Tool — Next.js (TypeScript) starter — *Corrected + Tests*

> This document replaces the previous canvas content and provides a corrected, runnable Next.js TypeScript starter that addresses the `SyntaxError: /index.tsx: Unexpected token (1:0)` problem. It also adds a minimal automated test to ensure the main page renders, and gives clear steps to run the app and tests locally.

---

## What's changed (summary)

- Replaced any accidental markdown or non-code content that may have been compiled as `.tsx` with valid TypeScript/JSX files.
- Added a minimal Jest + React Testing Library test so CI or local checks will fail fast if JSX compilation errors reappear.
- Included explicit `tsconfig.json`, `package.json` (with test scripts), and sample API routes.
- Kept the project deliberately minimal so you can extend it to integrate Microsoft Graph / Firebase later.

---

## Full file set (copy these into your repo)

Below are the files to create/replace. Paste them into the matching paths in your Git repo.


### `package.json`

```json
{
  "name": "courtesy-call-tool",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "test": "jest --passWithNoTests",
    "test:watch": "jest --watch"
  },
  "dependencies": {
    "firebase": "^9.22.0",
    "next": "14.1.0",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "formidable": "^3.7.0"
  },
  "devDependencies": {
    "@testing-library/jest-dom": "^6.0.0",
    "@testing-library/react": "^14.0.0",
    "@types/jest": "^29.5.3",
    "@types/node": "20.4.2",
    "@types/react": "18.2.28",
    "babel-jest": "^29.7.0",
    "jest": "^29.7.0",
    "typescript": "5.5.6"
  }
}
```


### `tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["DOM", "DOM.Iterable", "ESNext"],
    "allowJs": false,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "ESNext",
    "moduleResolution": "Node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
```


### `next-env.d.ts` (required by Next.js TypeScript projects)

```ts
/// <reference types="next" />
/// <reference types="next/types/global" />
/// <reference types="next/image-types/global" />
```


### `pages/index.tsx` (correct, minimal)

```tsx
import Head from 'next/head';
import { useState, useEffect } from 'react';

export default function Home() {
  const [message, setMessage] = useState('Loading...');

  useEffect(() => {
    setMessage('Courtesy Call Tool — Next.js (TypeScript) is running.');
  }, []);

  return (
    <>
      <Head>
        <title>Courtesy Call Tool</title>
        <meta name="description" content="Courtesy call tracker web tool" />
      </Head>
      <main style={{ padding: 24, fontFamily: 'Segoe UI, system-ui, Arial' }}>
        <h1>Courtesy Call Tool</h1>
        <p>{message}</p>
        <section style={{ marginTop: 16 }}>
          <p>Actions:</p>
          <ul>
            <li>Upload an Excel workbook (see <code>/api/upload</code>).</li>
            <li>Health check: <code>/api/health</code>.</li>
          </ul>
        </section>
      </main>
    </>
  );
}
```


### `pages/api/health.ts` (simple health check)

```ts
import type { NextApiRequest, NextApiResponse } from 'next';

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  res.status(200).json({ status: 'ok', timestamp: new Date().toISOString() });
}
```


### `pages/api/upload.ts` (example multipart handler — requires `formidable`)

```ts
import type { NextApiRequest, NextApiResponse } from 'next';
import formidable from 'formidable';

export const config = {
  api: {
    bodyParser: false
  }
};

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  const form = new formidable.IncomingForm();

  form.parse(req, (err, fields, files) => {
    if (err) return res.status(500).json({ error: 'Error parsing form' });

    const file = (files as any)?.file;
    if (!file) return res.status(400).json({ error: 'No file uploaded' });

    const tmpPath = (file as any).filepath || (file as any).path;
    const name = (file as any).originalFilename || (file as any).name || 'unknown.xlsx';

    // NOTE: This demo does NOT persist the file. Implement Graph upload here.
    res.status(200).json({ filename: name, tmpPath });
  });
}
```


### `lib/msgraph.ts` (skeleton helpers — implement later)

```ts
export async function uploadFileToOneDrive(localPath: string, filename: string): Promise<{ driveItemId: string } | null> {
  console.warn('uploadFileToOneDrive called — implement Graph upload flow');
  return { driveItemId: 'placeholder-drive-item-id' };
}

export async function appendAuditRow(auditWorkbookId: string, row: any): Promise<boolean> {
  console.warn('appendAuditRow called — implement Graph table row append');
  return true;
}
```


### `jest.config.cjs` (Jest setup)

```js
module.exports = {
  testEnvironment: 'jsdom',
  transform: {
    '^.+\\.(ts|tsx)$': 'babel-jest'
  },
  moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json'],
  setupFilesAfterEnv: ['<rootDir>/jest.setup.ts']
};
```


### `babel.config.js` (Babel for Jest)

```js
module.exports = {
  presets: ['next/babel']
};
```


### `jest.setup.ts`

```ts
import '@testing-library/jest-dom';
```


### `__tests__/index.test.tsx` (automated test — ensures page renders)

```tsx
import { render, screen } from '@testing-library/react';
import Home from '../pages/index';

describe('Home page', () => {
  it('renders header and message', () => {
    render(<Home />);
    expect(screen.getByRole('heading', { name: /Courtesy Call Tool/i })).toBeInTheDocument();
    // message appears asynchronously, but initial render includes 'Loading...'
    expect(screen.getByText(/Loading\.\.\./i)).toBeInTheDocument();
  });
});
```


### `.env.sample`

```
# Microsoft / Azure AD (if using Microsoft Graph)
AZURE_CLIENT_ID=
AZURE_CLIENT_SECRET=
AZURE_TENANT_ID=

# Firebase (if using Firebase Realtime DB for presence)
FIREBASE_API_KEY=
FIREBASE_AUTH_DOMAIN=
FIREBASE_PROJECT_ID=
FIREBASE_DATABASE_URL=

# Next.js
NEXTAUTH_URL=http://localhost:3000
```

---

## How this fixes the `SyntaxError`

- `pages/index.tsx` is valid TypeScript + JSX and begins with an `import` statement (no stray characters). The original error almost always indicates the file contained non-code characters (for example a `#` from a markdown heading) at the top of a `.tsx` file. Replacing the file with the content above eliminates that cause.
- The added Jest test will fail early if compilation of `index.tsx` is broken, giving a clearer error location in CI or locally.

---

## Run locally (step-by-step)

1. Install dependencies:

```bash
npm install
```

2. Start dev server:

```bash
npm run dev
```

Open `http://localhost:3000`.

3. Run tests:

```bash
npm test
```

You should see the test pass (or `passWithNoTests` will prevent failure if Jest can't find tests).

---

## Additional test cases (I added these)

- `__tests__/index.test.tsx` verifies the home page renders and initial text exists.

I can add more tests on request, for example:
- API route health check test (`/api/health`).
- Upload route integration test (requires file fixtures).

---

## If anything still fails

Please paste the **exact contents** (top ~50 lines) of the file that produced the `SyntaxError` (likely `pages/index.tsx` or another `.tsx` file). Also paste the command you used to start the app and the exact stack trace. I will patch the file immediately and return the corrected contents.

---

## Quick note / question for you (required)

To continue building features (uploading workbooks, audit logging, presence/notifications) I need to confirm expected behavior for several actions. Please answer these two short questions:

1. When a user edits a record on the website, should the site attempt to update the original uploaded workbook (the "foundation" workbook) in-place, or should all web edits only write to a separate audit workbook and leave the original file unchanged until a manual sync?
2. Do you have Microsoft 365 / OneDrive for Business available for storing the workbook and using Microsoft Graph, or should I implement the Google Sheets alternative?

Answering these will let me write the next API routes to match your intended workflow.

---

If you want, I can now:

- Paste any single corrected file again for quick copy/paste into your repo, or
- Generate full zip / file tree (I will paste all files here), or
- Apply further fixes if you paste the failing file contents.

Choose what you want me to do next and I will execute immediately.
